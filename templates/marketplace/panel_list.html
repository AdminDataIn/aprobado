{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Marketplace - {{ empresa.nombre }}</title>
    <link rel="stylesheet" href="{% static 'css/marketplace_admin.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="mp-admin">
    <header class="mp-admin-header">
        <div class="mp-admin-brand">
            <img src="{% static 'images/logo-dark.png' %}" alt="Aprobado">
            <div>
                <strong>Panel Marketplace</strong>
                <span>{{ empresa.nombre }}</span>
            </div>
        </div>
        <a href="{% url 'marketplace:item_create' %}" class="mp-admin-btn primary">
            <i class="bi bi-plus-lg"></i>Nueva publicación
        </a>
    </header>

    <main class="mp-admin-container">
        <!-- Estadísticas -->
        <div class="mp-stats-grid">
            <div class="mp-stat-card">
                <div class="mp-stat-icon blue">
                    <i class="bi bi-grid-3x3-gap"></i>
                </div>
                <div class="mp-stat-info">
                    <span class="mp-stat-label">Total publicaciones</span>
                    <strong class="mp-stat-value">{{ items|length }}</strong>
                </div>
            </div>
            <div class="mp-stat-card">
                <div class="mp-stat-icon green">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="mp-stat-info">
                    <span class="mp-stat-label">Aprobadas</span>
                    <strong class="mp-stat-value">{{ total_aprobados|default:0 }}</strong>
                </div>
            </div>
            <div class="mp-stat-card">
                <div class="mp-stat-icon yellow">
                    <i class="bi bi-clock"></i>
                </div>
                <div class="mp-stat-info">
                    <span class="mp-stat-label">Pendientes</span>
                    <strong class="mp-stat-value">{{ total_pendientes|default:0 }}</strong>
                </div>
            </div>
            <div class="mp-stat-card">
                <div class="mp-stat-icon purple">
                    <i class="bi bi-eye"></i>
                </div>
                <div class="mp-stat-info">
                    <span class="mp-stat-label">Vistas totales</span>
                    <strong class="mp-stat-value">{{ total_views|default:"0" }}</strong>
                </div>
            </div>
        </div>

        <!-- Tabla de publicaciones -->
        <section class="mp-admin-card">
                <div class="mp-admin-card-header">
                    <div>
                        <h2>Publicaciones</h2>
                        <p>Gestiona productos, servicios y publicidad de tu empresa. Usa el icono de reloj para ver el historial de estados.</p>
                    </div>
                <div class="mp-admin-filters">
                    <select class="mp-filter-select" id="filterStatus">
                        <option value="all">Todos los estados</option>
                        <option value="pendiente">Pendientes</option>
                        <option value="aprobado">Aprobadas</option>
                        <option value="rechazado">Rechazadas</option>
                        <option value="inactivo">Inactivas</option>
                    </select>
                    <select class="mp-filter-select" id="filterType">
                        <option value="all">Todos los tipos</option>
                        <option value="producto">Productos</option>
                        <option value="servicio">Servicios</option>
                        <option value="publicidad">Publicidad</option>
                    </select>
                </div>
            </div>

            <div class="mp-admin-table">
                <div class="mp-admin-row mp-admin-row-head">
                    <span>Título</span>
                    <span>Tipo</span>
                    <span>Estado</span>
                    <span>Fecha</span>
                    <span>Acciones</span>
                </div>
                {% for item in items %}
                <div class="mp-admin-row" data-status="{{ item.estado }}" data-type="{{ item.tipo }}" data-item-id="{{ item.id }}">
                    <div class="mp-admin-title">
                        <strong>{{ item.titulo }}</strong>
                        <small>{{ item.beneficio }}</small>
                    </div>
                    <span class="mp-pill">{{ item.get_tipo_display }}</span>
                    <span class="mp-status mp-status-{{ item.estado }}">{{ item.get_estado_display }}</span>
                    <span class="mp-date">{{ item.fecha_creacion|date:"d/m/Y" }}</span>
                    <div class="mp-admin-actions">
                        <button type="button" class="mp-action-btn" title="Ver historial" data-history-toggle="history-{{ item.id }}">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        <a href="{% url 'marketplace:item_edit' item.id %}" class="mp-action-btn" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        {% if item.estado == 'aprobado' and item.video %}
                        <a href="{{ item.video.url }}" target="_blank" class="mp-action-btn" title="Ver video">
                            <i class="bi bi-play-circle"></i>
                        </a>
                        {% elif item.estado == 'aprobado' and item.imagen %}
                        <a href="{{ item.imagen.url }}" target="_blank" class="mp-action-btn" title="Ver imagen">
                            <i class="bi bi-eye"></i>
                        </a>
                        {% endif %}
                        <form method="post" action="{% url 'marketplace:item_deactivate' item.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="mp-action-btn danger" title="Desactivar" onclick="return confirm('¿Estás seguro de desactivar esta publicación?')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="mp-history-row" id="history-{{ item.id }}" hidden>
                    <div class="mp-history-content">
                        <h4>
                            <i class="bi bi-clock-history"></i>
                            Historial de estado
                        </h4>
                        <ul class="mp-history-list">
                            {% for cambio in item.historial_estados.all|slice:":8" %}
                            <li>
                                <div class="mp-history-head">
                                    <span class="mp-status mp-status-{{ cambio.estado_nuevo }}">{{ cambio.get_estado_nuevo_display }}</span>
                                    <span class="mp-history-date">{{ cambio.fecha_cambio|date:"d/m/Y H:i" }}</span>
                                </div>
                                <p class="mp-history-meta">
                                    {{ cambio.get_origen_display }}
                                    {% if cambio.usuario %}· {{ cambio.usuario.username }}{% endif %}
                                </p>
                                {% if cambio.comentario %}
                                <p class="mp-history-note">{{ cambio.comentario }}</p>
                                {% endif %}
                            </li>
                            {% empty %}
                            <li>
                                <p class="mp-history-note">Sin cambios registrados todavia.</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% empty %}
                <div class="mp-admin-empty">
                    <i class="bi bi-inbox"></i>
                    <p>No hay publicaciones creadas aún</p>
                    <a href="{% url 'marketplace:item_create' %}" class="mp-admin-btn primary">
                        <i class="bi bi-plus-lg"></i>Crear primera publicación
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

    <script>
        // Filtros
        const filterStatus = document.getElementById('filterStatus');
        const filterType = document.getElementById('filterType');
        const rows = document.querySelectorAll('.mp-admin-row[data-status]');

        function applyFilters() {
            const statusValue = filterStatus.value;
            const typeValue = filterType.value;

            rows.forEach(row => {
                const status = row.dataset.status;
                const type = row.dataset.type;
                const historyRow = document.getElementById(`history-${row.dataset.itemId}`);

                const matchStatus = statusValue === 'all' || status === statusValue;
                const matchType = typeValue === 'all' || type === typeValue;

                row.style.display = matchStatus && matchType ? 'grid' : 'none';
                if (!matchStatus || !matchType) {
                    if (historyRow) historyRow.setAttribute('hidden', 'hidden');
                }
            });
        }

        if (filterStatus) filterStatus.addEventListener('change', applyFilters);
        if (filterType) filterType.addEventListener('change', applyFilters);

        // Historial por publicacion
        document.querySelectorAll('[data-history-toggle]').forEach((button) => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-history-toggle');
                const panel = document.getElementById(targetId);
                if (!panel) return;

                const isHidden = panel.hasAttribute('hidden');
                panel.toggleAttribute('hidden', !isHidden);
                button.classList.toggle('active', isHidden);
            });
        });
    </script>
</body>
</html>
