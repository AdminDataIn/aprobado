{% comment %}
=============================================================================
FORMULARIO DE SOLICITUD DE CRÉDITO DE LIBRANZA
=============================================================================
Este formulario es EXCLUSIVO para el producto de Crédito de Libranza.
NO está relacionado con emprendimiento ni otras líneas de crédito.

COMPONENTES UTILIZADOS:
- navbar_libranza.html (navbar exclusivo de Libranza)
- footer_libranza.html (footer exclusivo de Libranza)

FLUJO DEL FORMULARIO:
1. Paso 1: Información del Crédito (monto y plazo)
2. Paso 2: Información Personal (datos del solicitante)
3. Paso 3: Información Laboral (empresa y documentos adjuntos)

DOCUMENTOS REQUERIDOS:
- Cédula (frontal y trasera)
- Certificado bancario

PROCESAMIENTO:
- View: solicitud_credito_libranza_view (gestion_creditos/views.py)
- URL: /libranza/solicitar/
- Requiere autenticación con Google
- Envía email de confirmación automático

MODIFICAR:
- Campos del formulario: Líneas 65-185
- Validaciones JavaScript: Líneas 392-423
- Mensajes de error: Líneas 425-446
{% endcomment %}

<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprobado</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <style>
        .document-upload-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border: 1px solid #d9e2ec;
            border-radius: 16px;
            background: #f8fbff;
        }

        .document-upload-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .document-action-button {
            border: 0;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .document-action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
        }

        .document-action-button.primary {
            background: #0ea5c6;
            color: #ffffff;
        }

        .document-action-button.secondary {
            background: #e8f3fb;
            color: #0f3557;
            border: 1px solid #c9def0;
        }

        .document-upload-help {
            margin: 0;
            font-size: 13px;
            color: #64748b;
            line-height: 1.5;
        }

        .document-file-status {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 14px;
            background: #eef8ff;
            border: 1px solid #cfe8fb;
            color: #0f3557;
        }

        .document-file-status.visible {
            display: flex;
        }

        .document-file-status.has-file {
            background: #effaf3;
            border-color: #bfe6ca;
            color: #18603c;
        }

        .document-file-status .status-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: rgba(14, 165, 198, 0.12);
            color: #0ea5c6;
            flex-shrink: 0;
        }

        .document-file-status.has-file .status-icon {
            background: rgba(22, 163, 74, 0.14);
            color: #16a34a;
        }

        .document-file-status .status-text {
            min-width: 0;
        }

        .document-file-status .status-label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .document-file-status .status-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .camera-modal {
            position: fixed;
            inset: 0;
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(15, 23, 42, 0.78);
            backdrop-filter: blur(4px);
        }

        .camera-modal.visible {
            display: flex;
        }

        .camera-modal-dialog {
            width: min(100%, 720px);
            border-radius: 24px;
            background: #ffffff;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.2);
            overflow: hidden;
        }

        .camera-modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .camera-modal-header h3 {
            margin: 0 0 6px;
            font-size: 24px;
            color: #0f172a;
        }

        .camera-modal-header p {
            margin: 0;
            color: #64748b;
            line-height: 1.5;
        }

        .camera-close-button {
            border: 0;
            background: transparent;
            font-size: 28px;
            line-height: 1;
            color: #64748b;
            cursor: pointer;
        }

        .camera-modal-body {
            padding: 20px 24px 24px;
        }

        .camera-preview-shell {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 260px;
        }

        .camera-preview-shell video,
        .camera-preview-shell canvas {
            display: block;
            width: 100%;
            min-height: 260px;
            max-height: 70vh;
            object-fit: cover;
        }

        .camera-preview-overlay {
            position: absolute;
            inset: 0;
            border: 18px solid rgba(15, 23, 42, 0.32);
            pointer-events: none;
        }

        .camera-preview-guide {
            position: absolute;
            inset: 12%;
            border: 2px dashed rgba(255, 255, 255, 0.9);
            border-radius: 22px;
            pointer-events: none;
        }

        .camera-modal-footer {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            margin-top: 18px;
        }

        .camera-footer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .camera-status-message {
            margin: 14px 0 0;
            font-size: 14px;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .document-upload-actions {
                flex-direction: column;
            }

            .document-action-button {
                width: 100%;
            }

            .camera-modal {
                padding: 12px;
            }

            .camera-modal-header,
            .camera-modal-body {
                padding-left: 18px;
                padding-right: 18px;
            }

            .camera-modal-header h3 {
                font-size: 20px;
            }

            .camera-modal-footer,
            .camera-footer-actions {
                flex-direction: column;
            }

            .camera-footer-actions .document-action-button {
                width: 100%;
            }
        }
    </style>
</head>

<body class="body-index">
{% include 'base/loader_global.html' %}
<div class="div-body-main">
    {% include 'base/navbar_libranza.html' %}

    <main class="form-container">
        <div class="form-content">
            <!-- Panel lateral con pasos -->
            <div class="form-sidebar">
                <div class="form-title">
                    <h1>Solicitud de crédito de Libranza</h1>
                    <p>Rellena el formulario para iniciar tu solicitud de crédito.</p>
                </div>

                <div class="step-list">
                    <!-- Paso 1 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number active" id="step-indicator-1">1</div>
                            <div class="step-name active">Información del Crédito</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>

                    <!-- Paso 2 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number inactive" id="step-indicator-2">2</div>
                            <div class="step-name inactive">Información Personal</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>

                    <!-- Paso 3 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number inactive" id="step-indicator-3">3</div>
                            <div class="step-name inactive">Información Laboral</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>
                </div>
            </div>
            <!-- Contenido del formulario -->
            <div class="form-main">
                <div class="form-main-grid">
                    <div class="form-steps-column">
                        {# NUEVA URL - Libranza #}
                <form id="formularioLibranza" method="POST" enctype="multipart/form-data" action="{% url 'libranza:solicitar' %}" data-loader="ajax" data-loader-text="Enviando solicitud...">
                            {% csrf_token %}

                    <!-- Paso 1: Información del Crédito -->
                    <div class="form-step active" id="step-1">
                        <h2 class="step-title">Información del Crédito</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="valor_credito" class="form-label required">Valor crédito solicitado:</label>
                                <input type="text" id="valor_credito" name="valor_credito" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="plazo" class="form-label required">Plazo:</label>
                                <select id="plazo" name="plazo" class="form-select" required>
                                    <option value="">Seleccione una opción</option>
                                    <option value="1">1 mes</option>
                                    <option value="2">2 meses</option>
                                    <option value="3">3 meses</option>
                                    <option value="4">4 meses</option>
                                    <option value="5">5 meses</option>
                                    <option value="6">6 meses</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-actions">
                            <div></div> <!-- Espacio vacío para alinear el botón a la derecha -->
                            <button type="button" class="form-button next" onclick="nextStep(1)">Siguiente</button>
                        </div>
                    </div>

                    <!-- Paso 2: Información Personal -->
                    <div class="form-step" id="step-2">
                        <h2 class="step-title">Información Personal</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="nombres" class="form-label required">Nombres:</label>
                                <input type="text" id="nombres" name="nombres" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="apellidos" class="form-label required">Apellidos:</label>
                                <input type="text" id="apellidos" name="apellidos" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="cedula" class="form-label required">Número de cédula:</label>
                                <input type="text" id="cedula" name="cedula" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="direccion" class="form-label required">Dirección:</label>
                                <input type="text" id="direccion" name="direccion" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="telefono" class="form-label required">Celular (WhatsApp):</label>
                                <input type="text" id="telefono" name="telefono" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="correo_electronico" class="form-label required">Correo electrónico:</label>
                                <input type="email" id="correo_electronico" name="correo_electronico" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="form-button previous" onclick="previousStep(2)">Anterior</button>
                            <button type="button" class="form-button next" onclick="nextStep(2)">Siguiente</button>
                        </div>
                    </div>

                    <!-- Paso 3: Empresa y Negocio Archivos adjuntos-->
                    <div class="form-step" id="step-3">
                        <h2 class="step-title">Empresa y Negocio</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="id_empresa" class="form-label required">Nombre de la empresa:</label>
                                {{ form.empresa }}
                            </div>
                            <div class="form-field">
                                <label for="ingresos_mensuales" class="form-label required">Ingresos mensuales:</label>
                                <input type="text" id="ingresos_mensuales" name="ingresos_mensuales" class="form-input" required>
                            </div>
                            <!-- Adjuntar la cédula por ambas caras -->
                            <div class="form-field">
                                <label for="cedula_frontal" class="form-label required">Cedula (frontal):</label>
                                <div class="document-upload-card">
                                    <input type="file" id="cedula_frontal" name="cedula_frontal" class="form-input document-input" accept="image/*" required hidden>
                                    <div class="document-upload-actions">
                                        <button type="button" class="document-action-button primary open-camera-btn" data-target="cedula_frontal" data-label="Cedula frontal">Tomar foto</button>
                                    </div>
                                    <p class="document-upload-help">Este documento se captura unicamente en imagen para exigir la toma en vivo desde el dispositivo.</p>
                                    <div class="document-file-status visible" id="cedula_frontal_status">
                                        <span class="status-icon">i</span>
                                        <div class="status-text">
                                            <span class="status-label">Estado</span>
                                            <span class="status-value">No se ha seleccionado archivo.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="cedula_trasera" class="form-label required">Cedula (trasera):</label>
                                <div class="document-upload-card">
                                    <input type="file" id="cedula_trasera" name="cedula_trasera" class="form-input document-input" accept="image/*" required hidden>
                                    <div class="document-upload-actions">
                                        <button type="button" class="document-action-button primary open-camera-btn" data-target="cedula_trasera" data-label="Cedula trasera">Tomar foto</button>
                                    </div>
                                    <p class="document-upload-help">Este documento se captura unicamente en imagen para exigir la toma en vivo desde el dispositivo.</p>
                                    <div class="document-file-status visible" id="cedula_trasera_status">
                                        <span class="status-icon">i</span>
                                        <div class="status-text">
                                            <span class="status-label">Estado</span>
                                            <span class="status-value">No se ha seleccionado archivo.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- El certificado bancario se restringe a PDF para facilitar el OCR y evitar fotos borrosas. -->
                            <div class="form-field">
                                <label for="certificado_bancario" class="form-label required">Certificado Bancario:</label>
                                <div class="document-upload-card">
                                    <input type="file" id="certificado_bancario" name="certificado_bancario" class="form-input document-input" accept="application/pdf" required>
                                    <p class="document-upload-help">Carga unicamente el certificado bancario en PDF. No se permite captura por camara en este campo.</p>
                                    <div class="document-file-status visible" id="certificado_bancario_status">
                                        <span class="status-icon">i</span>
                                        <div class="status-text">
                                            <span class="status-label">Estado</span>
                                            <span class="status-value">No se ha seleccionado archivo.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Términos y condiciones -->
                        <div class="terms-container">
                            <div class="terms-content">
                                <input type="checkbox" id="terms" required>
                                <label for="terms" class="terms-text">
                                    Acepto los <a href="{% url 'terminos_condiciones' %}" class="terms-link">términos y condiciones</a> y autorizo el tratamiento de mis datos personales de acuerdo con la <a href="{% url 'politica_privacidad' %}" class="terms-link">política de privacidad</a>.
                                </label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="form-button previous" onclick="previousStep(3)">Anterior</button>
                            <button type="submit" class="form-button submit">Enviar Solicitud</button>
                        </div>
                    </div>
                        </form>
                    </div>

                    <aside class="credito-resumen-panel">
                        <div class="credito-resumen">
                            <h3 class="credito-resumen-title">Transparencia del crédito</h3>
                            <div class="credito-resumen-row">
                                <span>Monto solicitado:</span>
                                <span id="resumen-monto">-</span>
                            </div>
                            <div class="credito-resumen-row">
                                <span>Comisión (10%):</span>
                                <span id="resumen-comision">-</span>
                            </div>
                            <div class="credito-resumen-row">
                                <span>IVA sobre comisión (19%):</span>
                                <span id="resumen-iva">-</span>
                            </div>
                            <div class="credito-resumen-row">
                                <span>Intereses ({{ libranza_tasa_mensual|default:"1.9" }}% EM):</span>
                                <span id="resumen-intereses">-</span>
                            </div>
                                                        <div class="credito-resumen-row total">
                                <span>Total a pagar:</span>
                                <span id="resumen-total">-</span>
                            </div>
                            <div class="credito-resumen-row cuota">
                                <span>Cuota mensual:</span>
                                <span id="resumen-cuota">-</span>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </main>

    {% include 'base/footer_libranza.html' %}
</div>

<!-- Modal -->
<div id="modalMensaje" class="div-prin-modal">
    <div class="modal-contenido">
        <span class="close-span" id="cerrarModal">&times;</span>
        <div class="div-log-mod">
            <a href="/" class="logo">
                <img src="https://cdn.prod.website-files.com/670f349587d182fd0d7e63f9/670f356dcabf0942be108962_Aprobado.png"
                     alt="Logo"/>
            </a>
        </div>
        <p id="mensajeModal"></p>
    </div>
</div>

<!-- Modal reutilizable para capturar documentos desde camara sin tocar el backend. -->
<div id="cameraCaptureModal" class="camera-modal" aria-hidden="true">
    <div class="camera-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cameraModalTitle">
        <div class="camera-modal-header">
            <div>
                <h3 id="cameraModalTitle">Capturar documento</h3>
                <p id="cameraModalDescription">Ajusta el documento dentro del recuadro y toma la foto cuando este nitida.</p>
            </div>
            <button type="button" class="camera-close-button" id="closeCameraModal" aria-label="Cerrar captura">&times;</button>
        </div>
        <div class="camera-modal-body">
            <div class="camera-preview-shell">
                <video id="cameraPreview" autoplay playsinline muted></video>
                <canvas id="cameraCanvas" style="display:none;"></canvas>
                <div class="camera-preview-overlay"></div>
                <div class="camera-preview-guide"></div>
            </div>
            <div class="camera-modal-footer">
                <div class="camera-footer-actions">
                    <button type="button" class="document-action-button primary" id="capturePhotoButton">Capturar foto</button>
                    <button type="button" class="document-action-button secondary" id="retakePhotoButton" style="display:none;">Tomar otra</button>
                </div>
                <div class="camera-footer-actions">
                    <button type="button" class="document-action-button secondary" id="useCapturedPhotoButton" style="display:none;">Usar esta foto</button>
                    <button type="button" class="document-action-button secondary" id="cancelCameraButton">Cancelar</button>
                </div>
            </div>
            <p class="camera-status-message" id="cameraStatusMessage">La camara se abrir? con la lente trasera cuando el dispositivo lo permita.</p>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funcion para manejar los pasos del formulario
    function nextStep(currentStep) {
        // validar los campos del paso actual
        const step = document.getElementById(`step-${currentStep}`);
        const requiredFields = step.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = 'red';
                isValid = false;
                
                // Mostrar mensaje de error si no existe
                if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('error-message')) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'error-message';
                    errorMessage.textContent = 'Este campo es obligatorio.';
                    field.parentNode.insertBefore(errorMessage, field.nextSibling);
                }
            } else {
                field.style.borderColor = '';
                // Eliminar mensaje de error si existe
                if (field.nextElementSibling && field.nextElementSibling.classList.contains('error-message')) {
                    field.nextElementSibling.remove();
                }
            }
        });
        
        if (!isValid) {
            return;
        }

        // Ocultar paso actual
        step.classList.remove('active');

        // Mostrar siguiente paso
        const nextStepNumber = currentStep + 1;
        document.getElementById(`step-${nextStepNumber}`).classList.add('active');

        // Actualizar indicadores de pasos
        updateStepIndicators(currentStep, nextStepNumber);

        // Guardar datos en localStorage
        saveFormData();
    }

    function previousStep(currentStep) {
        // Ocultar paso actual
        document.getElementById(`step-${currentStep}`).classList.remove('active');

        // Mostrar paso anterior
        const prevStep = currentStep - 1;
        document.getElementById(`step-${prevStep}`).classList.add('active');

        // Actualizar indicadores de pasos
        updateStepIndicators(currentStep, prevStep);
    }

    function updateStepIndicators(currentStep, newStep) {
        // Resetear todos los indicadores a inactive
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const name = indicator.parentElement.nextElementSibling;

            indicator.classList.remove('active', 'completed');
            indicator.classList.add('inactive');
            name.classList.remove('active');
            name.classList.add('inactive');
        }

        // Marcar pasos anteriores como completados
        for (let i = 1; i < newStep; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const name = indicator.parentElement.nextElementSibling;

            indicator.classList.remove('inactive');
            indicator.classList.add('completed');
            name.classList.remove('inactive');
            name.classList.add('active');
        }

        // Marcar paso actual como activo
        const newIndicator = document.getElementById(`step-indicator-${newStep}`);
        const newName = newIndicator.parentElement.nextElementSibling;

        newIndicator.classList.remove('inactive', 'completed');
        newIndicator.classList.add('active');
        newName.classList.remove('inactive');
        newName.classList.add('active');
    }
    
    function saveFormData() {
        if (typeof(Storage) !== "undefined") {
            const formData = {};
            const form = document.getElementById('formularioLibranza');
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                if (input.type !== 'submit' && input.type !== 'button' && input.name !== 'csrfmiddlewaretoken') {
                    formData[input.name] = input.value;
                }
            });

            localStorage.setItem('formularioLibranzaData', JSON.stringify(formData));
        }
    }

    function loadFormData() {
        if (typeof(Storage) !== "undefined") {
            const savedData = localStorage.getItem('formularioLibranzaData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                const form = document.getElementById('formularioLibranza');

                for (const name in formData) {
                    const input = form.querySelector(`[name="${name}"]`);
                    if (input) {
                        // Manejar casos especiales para checkboxes y radios
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = formData[name] === 'on';
                        } else {
                            input.value = formData[name];
                        }
                    }
                }
            }
        }
    }

    // Cargar datos guardados al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        loadFormData();

        const maxValorCredito = 2000000;
        const valorCreditoInput = document.getElementById('valor_credito');
        const ingresosMensualesInput = document.getElementById('ingresos_mensuales');
        const plazoSelect = document.getElementById('plazo');
        const resumenMonto = document.getElementById('resumen-monto');
        const resumenComision = document.getElementById('resumen-comision');
        const resumenIva = document.getElementById('resumen-iva');
        const resumenIntereses = document.getElementById('resumen-intereses');
        const resumenTotal = document.getElementById('resumen-total');
        const resumenCuota = document.getElementById('resumen-cuota');
        // Referencias del flujo de camara: un modal reutilizable alimenta los tres inputs de documentos.
        const cameraModal = document.getElementById('cameraCaptureModal');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const cameraStatusMessage = document.getElementById('cameraStatusMessage');
        const cameraModalTitle = document.getElementById('cameraModalTitle');
        const cameraModalDescription = document.getElementById('cameraModalDescription');
        const capturePhotoButton = document.getElementById('capturePhotoButton');
        const retakePhotoButton = document.getElementById('retakePhotoButton');
        const useCapturedPhotoButton = document.getElementById('useCapturedPhotoButton');
        const closeCameraModalButton = document.getElementById('closeCameraModal');
        const cancelCameraButton = document.getElementById('cancelCameraButton');
        let lockedMonto = null;
        let lockedPlazo = null;
        let activeCameraInput = null;
        let activeCameraLabel = '';
        let currentCameraStream = null;
        let capturedCameraFile = null;

        const hiddenCaptureInput = document.createElement('input');
        hiddenCaptureInput.type = 'file';
        hiddenCaptureInput.accept = 'image/*';
        hiddenCaptureInput.capture = 'environment';
        hiddenCaptureInput.style.display = 'none';
        document.body.appendChild(hiddenCaptureInput);

        function formatCurrencyNoDecimals(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Refleja en pantalla si el input ya tiene archivo cargado o capturado.
        function actualizarEstadoArchivo(input) {
            if (!input) {
                return;
            }

            const statusBox = document.getElementById(`${input.id}_status`);
            if (!statusBox) {
                return;
            }

            const statusValue = statusBox.querySelector('.status-value');
            const statusIcon = statusBox.querySelector('.status-icon');
            const hasFile = input.files && input.files.length > 0;

            statusBox.classList.add('visible');
            statusBox.classList.toggle('has-file', hasFile);

            if (hasFile) {
                statusValue.textContent = input.files[0].name;
                statusIcon.textContent = 'OK';
            } else {
                statusValue.textContent = 'No se ha seleccionado archivo.';
                statusIcon.textContent = 'i';
            }
        }

        // Convierte la foto capturada en un File real y lo asigna al input original del formulario.
        function asignarArchivoAInput(input, file) {
            const transfer = new DataTransfer();
            transfer.items.add(file);
            input.files = transfer.files;
            actualizarEstadoArchivo(input);
        }

        function detenerCamara() {
            if (currentCameraStream) {
                currentCameraStream.getTracks().forEach(track => track.stop());
                currentCameraStream = null;
            }
        }

        function resetCameraCaptureState() {
            cameraCanvas.style.display = 'none';
            cameraPreview.style.display = 'block';
            capturePhotoButton.style.display = 'inline-flex';
            retakePhotoButton.style.display = 'none';
            useCapturedPhotoButton.style.display = 'none';
            capturedCameraFile = null;
        }

        function cerrarModalCamara() {
            detenerCamara();
            resetCameraCaptureState();
            cameraModal.classList.remove('visible');
            cameraModal.setAttribute('aria-hidden', 'true');
            activeCameraInput = null;
            activeCameraLabel = '';
            hiddenCaptureInput.value = '';
        }

        // Abre la camara para el input solicitado. Si el navegador falla, usa el capturador nativo del dispositivo.
        async function abrirCamaraParaInput(inputId, inputLabel) {
            const targetInput = document.getElementById(inputId);
            if (!targetInput) {
                return;
            }

            activeCameraInput = targetInput;
            activeCameraLabel = inputLabel;
            cameraModalTitle.textContent = `Capturar ${inputLabel.toLowerCase()}`;
            cameraModalDescription.textContent = `Ajusta ${inputLabel.toLowerCase()} dentro del recuadro y toma la foto cuando se vea nitida.`;
            cameraStatusMessage.textContent = 'Preparando camara...';
            resetCameraCaptureState();

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraStatusMessage.textContent = 'Este navegador no soporta la camara integrada. Se abrir? la camara nativa del dispositivo si est? disponible.';
                hiddenCaptureInput.onchange = function() {
                    if (hiddenCaptureInput.files && hiddenCaptureInput.files[0] && activeCameraInput) {
                        asignarArchivoAInput(activeCameraInput, hiddenCaptureInput.files[0]);
                    }
                };
                hiddenCaptureInput.click();
                return;
            }

            try {
                currentCameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1600 },
                        height: { ideal: 1200 }
                    },
                    audio: false
                });

                cameraPreview.srcObject = currentCameraStream;
                cameraModal.classList.add('visible');
                cameraModal.setAttribute('aria-hidden', 'false');
                cameraStatusMessage.textContent = 'La camara est? lista. Mant?n el documento dentro del recuadro.';
            } catch (error) {
                console.error('No fue posible abrir la camara:', error);
                cameraStatusMessage.textContent = 'No fue posible abrir la camara del navegador. Se intentar? usar la camara nativa del dispositivo.';
                hiddenCaptureInput.onchange = function() {
                    if (hiddenCaptureInput.files && hiddenCaptureInput.files[0] && activeCameraInput) {
                        asignarArchivoAInput(activeCameraInput, hiddenCaptureInput.files[0]);
                    }
                };
                hiddenCaptureInput.click();
            }
        }

        function calcularCuotaAnualidad(monto, tasaMensual, meses) {
            if (tasaMensual === 0) {
                return monto / meses;
            }
            const factor = Math.pow(1 + tasaMensual, meses);
            return monto * (tasaMensual * factor) / (factor - 1);
        }

        function limpiarResumen() {
            if (!resumenMonto) {
                return;
            }
            resumenMonto.textContent = '-';
            resumenComision.textContent = '-';
            resumenIva.textContent = '-';
            resumenIntereses.textContent = '-';
            resumenTotal.textContent = '-';
            resumenCuota.textContent = '-';
        }

        function obtenerMontoActual() {
            if (lockedMonto !== null) {
                return lockedMonto;
            }
            if (!valorCreditoInput) {
                return null;
            }
            const value = valorCreditoInput.value.replace(/\D/g, '');
            if (!value) {
                return null;
            }
            return parseInt(value, 10);
        }

        function obtenerPlazoActual() {
            if (lockedPlazo !== null) {
                return lockedPlazo;
            }
            if (!plazoSelect || !plazoSelect.value) {
                return null;
            }
            return parseInt(plazoSelect.value, 10);
        }

        function actualizarResumenCredito() {
            if (!resumenMonto) {
                return;
            }
            const montoSolicitado = obtenerMontoActual();
            const meses = obtenerPlazoActual();

            if (!montoSolicitado || !meses) {
                limpiarResumen();
                return;
            }

            const comision = montoSolicitado * 0.10;
            const ivaComision = comision * 0.19;

            const capitalFinanciado = montoSolicitado + comision + ivaComision;
            const tasaMensual = parseFloat('{{ libranza_tasa_decimal_js|default:"0.019" }}');
            const cuotaMensual = calcularCuotaAnualidad(capitalFinanciado, tasaMensual, meses);
            const totalAPagar = cuotaMensual * meses;
            const totalIntereses = totalAPagar - capitalFinanciado;

            resumenMonto.textContent = formatCurrency(montoSolicitado);
            resumenComision.textContent = formatCurrency(comision);
            resumenIva.textContent = formatCurrency(ivaComision);
            resumenIntereses.textContent = formatCurrency(totalIntereses);
            resumenTotal.textContent = formatCurrency(totalAPagar);
            resumenCuota.textContent = formatCurrency(cuotaMensual);
        }

        function aplicarDatosSimulador() {
            const params = new URLSearchParams(window.location.search);
            const montoParam = params.get('monto');
            const plazoParam = params.get('plazo');

            if (montoParam && valorCreditoInput) {
                let montoValue = parseInt(montoParam, 10);
                if (!Number.isNaN(montoValue)) {
                    if (montoValue > maxValorCredito) {
                        montoValue = maxValorCredito;
                    }
                    if (montoValue > 0) {
                        lockedMonto = montoValue;
                        valorCreditoInput.value = formatCurrencyNoDecimals(montoValue);
                        valorCreditoInput.readOnly = true;
                        valorCreditoInput.setAttribute('data-locked', 'true');
                    }
                }
            }

            if (plazoParam && plazoSelect) {
                let plazoValue = parseInt(plazoParam, 10);
                if (!Number.isNaN(plazoValue) && plazoValue >= 1 && plazoValue <= 6) {
                    lockedPlazo = plazoValue;
                    plazoSelect.value = String(plazoValue);
                    plazoSelect.setAttribute('disabled', 'disabled');
                    plazoSelect.setAttribute('data-locked', 'true');

                    let plazoLockedInput = document.getElementById('plazo_locked');
                    if (!plazoLockedInput) {
                        plazoLockedInput = document.createElement('input');
                        plazoLockedInput.type = 'hidden';
                        plazoLockedInput.id = 'plazo_locked';
                        plazoLockedInput.name = 'plazo';
                        plazoSelect.parentNode.appendChild(plazoLockedInput);
                    }
                    plazoLockedInput.value = String(plazoValue);
                }
            }

            actualizarResumenCredito();
        }

        if (valorCreditoInput) {
            valorCreditoInput.addEventListener('input', function(e) {
                if (valorCreditoInput.dataset.locked === 'true') {
                    if (lockedMonto !== null) {
                        e.target.value = formatCurrencyNoDecimals(lockedMonto);
                    }
                    return;
                }

                let value = e.target.value.replace(/\D/g, '');
                if (value) {
                    let numberValue = parseInt(value, 10);
                    if (numberValue > maxValorCredito) {
                        numberValue = maxValorCredito;
                    }
                    e.target.value = formatCurrencyNoDecimals(numberValue);
                } else {
                    e.target.value = '';
                }
                actualizarResumenCredito();
            });
        }

        if (ingresosMensualesInput) {
            ingresosMensualesInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value) {
                    const numberValue = parseInt(value, 10);
                    e.target.value = formatCurrencyNoDecimals(numberValue);
                } else {
                    e.target.value = '';
                }
            });
        }

        if (plazoSelect) {
            plazoSelect.addEventListener('change', actualizarResumenCredito);
        }

        document.querySelectorAll('.document-input').forEach(input => {
            actualizarEstadoArchivo(input);
            input.addEventListener('change', function() {
                actualizarEstadoArchivo(input);
            });
        });

        // Cada boton 'Tomar foto' apunta a un input file existente mediante data-target.
        document.querySelectorAll('.open-camera-btn').forEach(button => {
            button.addEventListener('click', function() {
                abrirCamaraParaInput(button.dataset.target, button.dataset.label || 'documento');
            });
        });

        // Captura un frame del video, lo comprime a JPEG y lo prepara para ser enviado como archivo normal.
        capturePhotoButton.addEventListener('click', function() {
            if (!activeCameraInput) {
                return;
            }

            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraPreview.videoWidth || 1600;
            cameraCanvas.height = cameraPreview.videoHeight || 1200;
            context.drawImage(cameraPreview, 0, 0, cameraCanvas.width, cameraCanvas.height);

            cameraCanvas.toBlob(function(blob) {
                if (!blob) {
                    cameraStatusMessage.textContent = 'No fue posible capturar la imagen. Intentalo nuevamente.';
                    return;
                }

                capturedCameraFile = new File(
                    [blob],
                    `${activeCameraInput.name}-${Date.now()}.jpg`,
                    { type: 'image/jpeg' }
                );

                cameraPreview.style.display = 'none';
                cameraCanvas.style.display = 'block';
                capturePhotoButton.style.display = 'none';
                retakePhotoButton.style.display = 'inline-flex';
                useCapturedPhotoButton.style.display = 'inline-flex';
                cameraStatusMessage.textContent = 'Foto capturada. Revisa si quedo legible antes de usarla.';
            }, 'image/jpeg', 0.88);
        });

        retakePhotoButton.addEventListener('click', function() {
            resetCameraCaptureState();
            cameraStatusMessage.textContent = 'Ajusta nuevamente el documento y toma otra foto.';
        });

        useCapturedPhotoButton.addEventListener('click', function() {
            if (!activeCameraInput || !capturedCameraFile) {
                return;
            }
            asignarArchivoAInput(activeCameraInput, capturedCameraFile);
            cerrarModalCamara();
        });

        closeCameraModalButton.addEventListener('click', cerrarModalCamara);
        cancelCameraButton.addEventListener('click', cerrarModalCamara);

        cameraModal.addEventListener('click', function(event) {
            if (event.target === cameraModal) {
                cerrarModalCamara();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && cameraModal.classList.contains('visible')) {
                cerrarModalCamara();
            }
        });

        aplicarDatosSimulador();

        const formulario = document.getElementById('formularioLibranza');
        const modal = document.getElementById("modalMensaje");
        const closeButton = document.getElementById("cerrarModal");

        if (!formulario) {
            console.error('No se encontró el formulario con ID "formularioLibranza"');
            return;
        }

        formulario.addEventListener('submit', function (e) {
            e.preventDefault();
            if (validarFormularioCompleto()) {
                enviarFormulario();
            }
        });

        function validarFormularioCompleto() {
            const camposRequeridos = formulario.querySelectorAll('[required]');
            let valido = true;

            camposRequeridos.forEach(campo => {
                // Ignorar campos ocultos (de otros pasos)
                if (campo.closest('.form-step') && !campo.closest('.form-step').classList.contains('active')) {
                    return;
                }

                if (!campo.value.trim() && campo.type !== 'file') {
                    mostrarError(campo, 'Este campo es requerido');
                    valido = false;
                } else if (campo.type === 'file' && campo.files.length === 0) {
                    mostrarError(campo, 'Debes subir un archivo');
                    valido = false;
                } else {
                    limpiarError(campo);
                }
            });

            // Validar checkbox de términos
            const termsCheckbox = document.getElementById('terms');
            if (!termsCheckbox.checked) {
                mostrarError(termsCheckbox, 'Debes aceptar los términos y condiciones');
                valido = false;
            } else {
                limpiarError(termsCheckbox);
            }

            return valido;
        }

        function mostrarError(campo, mensaje) {
            campo.style.borderColor = 'red';
            let errorElement = campo.nextElementSibling;

            // Si es un checkbox, el mensaje va después del label
            if (campo.type === 'checkbox') {
                errorElement = campo.closest('.terms-content').nextElementSibling;
                if (!errorElement || !errorElement.classList.contains('error-message')) {
                    errorElement = document.createElement('div');
                    errorElement.className = 'error-message';
                    campo.closest('.terms-container').appendChild(errorElement);
                }
            }
            // Para otros campos
            else if (!errorElement || !errorElement.classList.contains('error-message')) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                campo.parentNode.insertBefore(errorElement, campo.nextSibling);
            }

            errorElement.textContent = mensaje;
        }

        function limpiarError(campo) {
            campo.style.borderColor = '';
            let errorElement;

            if (campo.type === 'checkbox') {
                errorElement = campo.closest('.terms-content').nextElementSibling;
            } else {
                errorElement = campo.nextElementSibling;
            }

            if (errorElement && errorElement.classList.contains('error-message')) {
                errorElement.remove();
            }
        }

        function limpiarTodosLosErrores() {
            const errorMessages = formulario.querySelectorAll('.error-message');
            errorMessages.forEach(error => error.remove());
            const fieldsWithErrors = formulario.querySelectorAll('[style*="border-color: red"]');
            fieldsWithErrors.forEach(field => field.style.borderColor = '');
        }

        function obtenerPasoPorCampo(campo) {
            const contenedorPaso = campo ? campo.closest('.form-step') : null;
            if (!contenedorPaso || !contenedorPaso.id) {
                return 1;
            }
            const match = contenedorPaso.id.match(/^step-(\d+)$/);
            return match ? parseInt(match[1], 10) : 1;
        }

        function irAlPasoConError(fieldName) {
            const field = formulario.querySelector(`[name="${fieldName}"]`);
            if (!field) {
                return;
            }

            const targetStep = obtenerPasoPorCampo(field);
            if (!Number.isInteger(targetStep)) {
                return;
            }

            const currentStepElement = document.querySelector('.form-step.active');
            const currentStep = currentStepElement
                ? parseInt(currentStepElement.id.replace('step-', ''), 10)
                : 1;

            if (currentStep !== targetStep) {
                document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
                document.getElementById(`step-${targetStep}`).classList.add('active');
                updateStepIndicators(currentStep, targetStep);
            }

            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function enviarFormulario() {
            const submitButton = formulario.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            if (window.AprobadoLoader) {
                window.AprobadoLoader.show('Enviando solicitud...');
            }

            limpiarTodosLosErrores();

            // Handle currency formatting before submission
            const valorCreditoInput = document.getElementById('valor_credito');
            const originalFormattedValue = valorCreditoInput.value;
            if (originalFormattedValue) {
                const numericValue = originalFormattedValue.replace(/\D/g, '');
                valorCreditoInput.value = numericValue;
            }
            const ingresosMensualesInput = document.getElementById('ingresos_mensuales');
            const originalIngresosValue = ingresosMensualesInput ? ingresosMensualesInput.value : '';
            if (ingresosMensualesInput && originalIngresosValue) {
                const numericIngresosValue = originalIngresosValue.replace(/\D/g, '');
                ingresosMensualesInput.value = numericIngresosValue;
            }

            const formData = new FormData(formulario);

            formData.append('user_id', '{{ user.id }}');

            const csrfToken = formulario.querySelector('[name="csrfmiddlewaretoken"]').value;

            fetch(formulario.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
            })
            .then(response => {
                if (response.status === 403) {
                    window.location.reload();
                    return Promise.reject('Authentication required');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mensaje simple de éxito sin validación de estimaciones
                    const mensaje = "Solicitud enviada exitosamente!\n\nHemos recibido tu solicitud de crédito de libranza y toda la documentación. Nuestro equipo la revisará y te contactaremos pronto con una respuesta.";
                    mostrarModal(mensaje);

                    // Limpiar el formulario después de enviar exitosamente
                    formulario.reset();
                    localStorage.removeItem('formularioLibranzaData');
                    
                    // Reiniciar al primer paso
                    document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
                    document.getElementById('step-1').classList.add('active');
                    updateStepIndicators(3, 1);
                } else {
                    if (data.errors) {
                        const fieldsWithErrors = Object.keys(data.errors);
                        fieldsWithErrors.forEach(fieldName => {
                            const field = formulario.querySelector(`[name="${fieldName}"]`);
                            const errorMessage = data.errors[fieldName][0];
                            if (field) {
                                mostrarError(field, errorMessage);
                            }
                        });

                        const firstErrorField = fieldsWithErrors[0];
                        if (firstErrorField) {
                            irAlPasoConError(firstErrorField);
                        }

                        const cedulaErrors = data.errors.cedula || [];
                        if (cedulaErrors.length > 0) {
                            const firstCedulaError = String(cedulaErrors[0]).toLowerCase();
                            if (firstCedulaError.includes('ya existe')) {
                                mostrarModal('Ya existe una solicitud registrada con esta cédula. Si necesitas apoyo, escríbenos por WhatsApp.');
                            }
                        }
                    } else {
                        alert('Error en la solicitud: ' + (data.error || 'Error desconocido'));
                    }
                }
            })
            .catch(error => {
                if (error !== 'Authentication required') {
                    console.error('Error:', error);
                    alert('Ocurrió un error al enviar el formulario. Por favor, inténtalo nuevamente.');
                }
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Solicitud';
                // Restore formatted value
                if (originalFormattedValue) {
                    valorCreditoInput.value = originalFormattedValue;
                }
                if (ingresosMensualesInput && originalIngresosValue) {
                    ingresosMensualesInput.value = originalIngresosValue;
                }
                if (window.AprobadoLoader) {
                    window.AprobadoLoader.hide();
                }
            });
        }

        function mostrarModal(mensaje) {
            document.getElementById("mensajeModal").textContent = mensaje;
            document.getElementById("modalMensaje").style.display = "flex";

            // Desplazarse al modal
            document.getElementById("modalMensaje").scrollIntoView({ behavior: 'smooth' });
        }

        function cerrarModal() {
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", cerrarModal);

        // Cerrar modal al hacer clic fuera del contenido
        modal.addEventListener("click", function(e) {
            if (e.target === modal) {
                cerrarModal();
            }
        });
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<script src="{% static 'js/global_loader.js' %}"></script>

</body>
</html>
