{% comment %} 
adapter.py: Se ejecuta solo durante el registro de un nuevo usuario social (con Google, por ejemplo) y lo asigna al grupo 'Empleados'.
context_processors.py: Se ejecuta con cada página que visitas. 
Su trabajo es hacer que la variable es_empleado esté disponible en todos los templates, para que los botones y enlaces puedan cambiar dinámicamente. 
{% endcomment %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Aprobado</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
</head>

<body class="body-index">
<div class="div-body-main">
    {% include 'base/navbar.html' %}

    <main class="form-container">
        <div class="form-content">
            <!-- Panel lateral con pasos -->
            <div class="form-sidebar">
                <div class="form-title">
                    <h1>Solicitud de crédito de Libranza</h1>
                    <p>Rellena el formulario para iniciar tu solicitud de crédito.</p>
                </div>

                <div class="step-list">
                    <!-- Paso 1 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number active" id="step-indicator-1">1</div>
                            <div class="step-name active">Información del Crédito</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>

                    <!-- Paso 2 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number inactive" id="step-indicator-2">2</div>
                            <div class="step-name inactive">Información Personal</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>

                    <!-- Paso 3 -->
                    <div class="step-item">
                        <div class="step-content">
                            <div class="step-number inactive" id="step-indicator-3">3</div>
                            <div class="step-name inactive">Información Laboral</div>
                        </div>
                        <div class="step-connector"></div>
                    </div>
                </div>
            </div>
            <!-- Contenido del formulario -->
            <div class="form-main">
                <form id="formularioLibranza" method="POST" enctype="multipart/form-data" action="{% url 'gestion_creditos:solicitud_libranza' %}">
                    {% csrf_token %}

                    <!-- Paso 1: Información del Crédito -->
                    <div class="form-step active" id="step-1">
                        <h2 class="step-title">Información del Crédito</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="valor_credito" class="form-label required">Valor crédito solicitado:</label>
                                <input type="text" id="valor_credito" name="valor_credito" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="plazo" class="form-label required">Plazo:</label>
                                <select id="plazo" name="plazo" class="form-select" required>
                                    <option value="">Seleccione una opción</option>
                                    <option value="1">1 mes</option>
                                    <option value="2">2 meses</option>
                                    <option value="3">3 meses</option>
                                    <option value="4">4 meses</option>
                                    <option value="5">5 meses</option>
                                    <option value="6">6 meses</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-actions">
                            <div></div> <!-- Espacio vacío para alinear el botón a la derecha -->
                            <button type="button" class="form-button next" onclick="nextStep(1)">Siguiente</button>
                        </div>
                    </div>

                    <!-- Paso 2: Información Personal -->
                    <div class="form-step" id="step-2">
                        <h2 class="step-title">Información Personal</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="nombres" class="form-label required">Nombres:</label>
                                <input type="text" id="nombres" name="nombres" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="apellidos" class="form-label required">Apellidos:</label>
                                <input type="text" id="apellidos" name="apellidos" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="cedula" class="form-label required">Número de cédula:</label>
                                <input type="text" id="cedula" name="cedula" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="direccion" class="form-label required">Dirección:</label>
                                <input type="text" id="direccion" name="direccion" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="telefono" class="form-label required">Celular (WhatsApp):</label>
                                <input type="text" id="telefono" name="telefono" class="form-input" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="correo_electronico" class="form-label required">Correo electrónico:</label>
                                <input type="email" id="correo_electronico" name="correo_electronico" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="form-button previous" onclick="previousStep(2)">Anterior</button>
                            <button type="button" class="form-button next" onclick="nextStep(2)">Siguiente</button>
                        </div>
                    </div>

                    <!-- Paso 3: Empresa y Negocio Archivos adjuntos-->
                    <div class="form-step" id="step-3">
                        <h2 class="step-title">Empresa y Negocio</h2>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="id_empresa" class="form-label required">Nombre de la empresa:</label>
                                {{ form.empresa }}
                            </div>
                            <!-- Adjuntar la cédula por ambas caras -->
                            <div class="form-field">
                                <label for="cedula_frontal" class="form-label required">Cédula (frontal):</label>
                                <input type="file" id="cedula_frontal" name="cedula_frontal" class="form-input" accept="image/*,application/pdf" required>
                            </div>
                            <div class="form-field">
                                <label for="cedula_trasera" class="form-label required">Cédula (trasera):</label>
                                <input type="file" id="cedula_trasera" name="cedula_trasera" class="form-input" accept="image/*,application/pdf" required>
                            </div>
                            <!-- Adjuntar Certificado Laboral -->
                            <div class="form-field">
                                <label for="certificado_laboral" class="form-label required">Certificado Laboral:</label>
                                <input type="file" id="certificado_laboral" name="certificado_laboral" class="form-input" accept="image/*,application/pdf" required>
                            </div>
                            <!-- Adjuntar el Último desprendible -->
                            <div class="form-field">
                                <label for="desprendible_nomina" class="form-label required">Último Desprendible de Pago:</label>
                                <input type="file" id="desprendible_nomina" name="desprendible_nomina" class="form-input" accept="image/*,application/pdf" required>
                            </div>
                            <!-- Adjuntar el Certificado Bancario -->
                            <div class="form-field">
                                <label for="certificado_bancario" class="form-label required">Certificado Bancario:</label>
                                <input type="file" id="certificado_bancario" name="certificado_bancario" class="form-input" accept="image/*,application/pdf" required>
                            </div>
                        </div>

                        <!-- Términos y condiciones -->
                        <div class="terms-container">
                            <div class="terms-content">
                                <input type="checkbox" id="terms" required>
                                <label for="terms" class="terms-text">
                                    Acepto los <a href="#" class="terms-link">términos y condiciones</a> y autorizo el tratamiento de mis datos personales de acuerdo con la <a href="#" class="terms-link">política de privacidad</a>.
                                </label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="form-button previous" onclick="previousStep(3)">Anterior</button>
                            <button type="submit" class="form-button submit">Enviar Solicitud</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    {% include 'base/footer.html' %}
</div>

<!-- Modal -->
<div id="modalMensaje" class="div-prin-modal">
    <div class="modal-contenido">
        <span class="close-span" id="cerrarModal">&times;</span>
        <div class="div-log-mod">
            <a href="/" class="logo">
                <img src="https://cdn.prod.website-files.com/670f349587d182fd0d7e63f9/670f356dcabf0942be108962_Aprobado.png"
                     alt="Logo"/>
            </a>
        </div>
        <p id="mensajeModal"></p>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funcion para manejar los pasos del formulario
    function nextStep(currentStep) {
        // validar los campos del paso actual
        const step = document.getElementById(`step-${currentStep}`);
        const requiredFields = step.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = 'red';
                isValid = false;
                
                // Mostrar mensaje de error si no existe
                if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('error-message')) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'error-message';
                    errorMessage.textContent = 'Este campo es obligatorio.';
                    field.parentNode.insertBefore(errorMessage, field.nextSibling);
                }
            } else {
                field.style.borderColor = '';
                // Eliminar mensaje de error si existe
                if (field.nextElementSibling && field.nextElementSibling.classList.contains('error-message')) {
                    field.nextElementSibling.remove();
                }
            }
        });
        
        if (!isValid) {
            return;
        }

        // Ocultar paso actual
        step.classList.remove('active');

        // Mostrar siguiente paso
        const nextStepNumber = currentStep + 1;
        document.getElementById(`step-${nextStepNumber}`).classList.add('active');

        // Actualizar indicadores de pasos
        updateStepIndicators(currentStep, nextStepNumber);

        // Guardar datos en localStorage
        saveFormData();
    }

    function previousStep(currentStep) {
        // Ocultar paso actual
        document.getElementById(`step-${currentStep}`).classList.remove('active');

        // Mostrar paso anterior
        const prevStep = currentStep - 1;
        document.getElementById(`step-${prevStep}`).classList.add('active');

        // Actualizar indicadores de pasos
        updateStepIndicators(currentStep, prevStep);
    }

    function updateStepIndicators(currentStep, newStep) {
        // Resetear todos los indicadores a inactive
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const name = indicator.parentElement.nextElementSibling;

            indicator.classList.remove('active', 'completed');
            indicator.classList.add('inactive');
            name.classList.remove('active');
            name.classList.add('inactive');
        }

        // Marcar pasos anteriores como completados
        for (let i = 1; i < newStep; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const name = indicator.parentElement.nextElementSibling;

            indicator.classList.remove('inactive');
            indicator.classList.add('completed');
            name.classList.remove('inactive');
            name.classList.add('active');
        }

        // Marcar paso actual como activo
        const newIndicator = document.getElementById(`step-indicator-${newStep}`);
        const newName = newIndicator.parentElement.nextElementSibling;

        newIndicator.classList.remove('inactive', 'completed');
        newIndicator.classList.add('active');
        newName.classList.remove('inactive');
        newName.classList.add('active');
    }
    
    function saveFormData() {
        if (typeof(Storage) !== "undefined") {
            const formData = {};
            const form = document.getElementById('formularioLibranza');
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                if (input.type !== 'submit' && input.type !== 'button') {
                    formData[input.name] = input.value;
                }
            });

            localStorage.setItem('formularioLibranzaData', JSON.stringify(formData));
        }
    }

    function loadFormData() {
        if (typeof(Storage) !== "undefined") {
            const savedData = localStorage.getItem('formularioLibranzaData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                const form = document.getElementById('formularioLibranza');

                for (const name in formData) {
                    const input = form.querySelector(`[name="${name}"]`);
                    if (input) {
                        // Manejar casos especiales para checkboxes y radios
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = formData[name] === 'on';
                        } else {
                            input.value = formData[name];
                        }
                    }
                }
            }
        }
    }

    // Cargar datos guardados al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        loadFormData();

        const formulario = document.getElementById('formularioLibranza');
        const modal = document.getElementById("modalMensaje");
        const closeButton = document.getElementById("cerrarModal");

        if (!formulario) {
            console.error('No se encontró el formulario con ID "formularioLibranza"');
            return;
        }

        formulario.addEventListener('submit', function (e) {
            e.preventDefault();
            if (validarFormularioCompleto()) {
                enviarFormulario();
            }
        });

        function validarFormularioCompleto() {
            const camposRequeridos = formulario.querySelectorAll('[required]');
            let valido = true;

            camposRequeridos.forEach(campo => {
                // Ignorar campos ocultos (de otros pasos)
                if (campo.closest('.form-step') && !campo.closest('.form-step').classList.contains('active')) {
                    return;
                }

                if (!campo.value.trim() && campo.type !== 'file') {
                    mostrarError(campo, 'Este campo es requerido');
                    valido = false;
                } else if (campo.type === 'file' && campo.files.length === 0) {
                    mostrarError(campo, 'Debes subir un archivo');
                    valido = false;
                } else {
                    limpiarError(campo);
                }
            });

            // Validar checkbox de términos
            const termsCheckbox = document.getElementById('terms');
            if (!termsCheckbox.checked) {
                mostrarError(termsCheckbox, 'Debes aceptar los términos y condiciones');
                valido = false;
            } else {
                limpiarError(termsCheckbox);
            }

            return valido;
        }

        function mostrarError(campo, mensaje) {
            campo.style.borderColor = 'red';
            let errorElement = campo.nextElementSibling;

            // Si es un checkbox, el mensaje va después del label
            if (campo.type === 'checkbox') {
                errorElement = campo.closest('.terms-content').nextElementSibling;
                if (!errorElement || !errorElement.classList.contains('error-message')) {
                    errorElement = document.createElement('div');
                    errorElement.className = 'error-message';
                    campo.closest('.terms-container').appendChild(errorElement);
                }
            }
            // Para otros campos
            else if (!errorElement || !errorElement.classList.contains('error-message')) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                campo.parentNode.insertBefore(errorElement, campo.nextSibling);
            }

            errorElement.textContent = mensaje;
        }

        function limpiarError(campo) {
            campo.style.borderColor = '';
            let errorElement;

            if (campo.type === 'checkbox') {
                errorElement = campo.closest('.terms-content').nextElementSibling;
            } else {
                errorElement = campo.nextElementSibling;
            }

            if (errorElement && errorElement.classList.contains('error-message')) {
                errorElement.remove();
            }
        }

        function limpiarTodosLosErrores() {
            const errorMessages = formulario.querySelectorAll('.error-message');
            errorMessages.forEach(error => error.remove());
            const fieldsWithErrors = formulario.querySelectorAll('[style*="border-color: red"]');
            fieldsWithErrors.forEach(field => field.style.borderColor = '');
        }

        function enviarFormulario() {
            const submitButton = formulario.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            limpiarTodosLosErrores();

            const formData = new FormData(formulario);

            const csrfToken = getCookie('csrftoken');

            formData.append('user_id', '{{ user.id }}');

            fetch(formulario.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
            })
            .then(response => {
                if (response.status === 403) {
                    window.location.reload();
                    return Promise.reject('Authentication required');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mensaje simple de éxito sin validación de estimaciones
                    const mensaje = "Solicitud enviada exitosamente!\n\nHemos recibido tu solicitud de crédito de libranza y toda la documentación. Nuestro equipo la revisará y te contactaremos pronto con una respuesta.";
                    mostrarModal(mensaje);

                    // Limpiar el formulario después de enviar exitosamente
                    formulario.reset();
                    localStorage.removeItem('formularioLibranzaData');
                    
                    // Reiniciar al primer paso
                    document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
                    document.getElementById('step-1').classList.add('active');
                    updateStepIndicators(3, 1);
                } else {
                    if (data.errors) {
                        Object.keys(data.errors).forEach(fieldName => {
                            const field = formulario.querySelector(`[name="${fieldName}"]`);
                            const errorMessage = data.errors[fieldName][0];
                            if (field) {
                                mostrarError(field, errorMessage);
                            }
                        });
                    } else {
                        alert('Error en la solicitud: ' + (data.error || 'Error desconocido'));
                    }
                }
            })
            .catch(error => {
                if (error !== 'Authentication required') {
                    console.error('Error:', error);
                    alert('Ocurrió un error al enviar el formulario. Por favor, inténtalo nuevamente.');
                }
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Solicitud';
            });
        }

        function mostrarModal(mensaje) {
            document.getElementById("mensajeModal").textContent = mensaje;
            document.getElementById("modalMensaje").style.display = "flex";

            // Desplazarse al modal
            document.getElementById("modalMensaje").scrollIntoView({ behavior: 'smooth' });
        }

        function cerrarModal() {
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", cerrarModal);

        // Cerrar modal al hacer clic fuera del contenido
        modal.addEventListener("click", function(e) {
            if (e.target === modal) {
                cerrarModal();
            }
        });
    });
</script>